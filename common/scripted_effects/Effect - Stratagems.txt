#-----------------------------------
# On Actions
#-----------------------------------
on_monthly_pulse__stratagems = {
    
}

on_battle_won_country__stratagems = {
    show_stratagem_notifications = yes
}

on_battle_lost_country__stratagems = {
    show_stratagem_notifications = yes
}

on_war_won__stratagems = {   
    # Stratagem Notification Reset
    country_event = { id = wwu_stratagems.99 days = 3 }
    
    FROM = {
        # Stratagem Notification Reset
        country_event = { id = wwu_stratagems.99 days = 3 }
    }
}

on_siege_won_province__stratagems = {
    # Defensive Stratagems
    martyrdom_stratagem = yes
    sabotage_stratagem = yes
    slander_stratagem = yes
    
    # Insurrection Stratagems
    bribery_stratagem = yes
    compromise_stratagem = yes
    garrison_stratagem = yes
}

on_siege_lost_province__stratagems = {
    # Offensive Stratagems
    sow_terror_stratagem = yes
    slash_and_burn_stratagem = yes
    enslavement_stratagem = yes
    purification_stratagem = yes
}

#-----------------------------------
# Misc
#-----------------------------------
setup_default_stratagem_assignment = {
    # Default for all
    set_offensive_stratagem = { TYPE = standard }
    set_defensive_stratagem = { TYPE = standard }
    set_insurrection_stratagem = { TYPE = standard }
}

set_offensive_stratagem = {
    hidden_effect = {
        clr_country_flag = offensive_stratagem__standard
        clr_country_flag = offensive_stratagem__sow_terror
        clr_country_flag = offensive_stratagem__slash_and_burn
        clr_country_flag = offensive_stratagem__enslavement
        clr_country_flag = offensive_stratagem__purification

        set_country_flag = offensive_stratagem__$TYPE$
    }
    
    custom_tooltip = OFFENSIVE_STRATAGEM_$TYPE$_TT
}

set_defensive_stratagem = {
    hidden_effect = {
        clr_country_flag = defensive_stratagem__standard
        clr_country_flag = defensive_stratagem__martyrdom
        clr_country_flag = defensive_stratagem__sabotage
        clr_country_flag = defensive_stratagem__slander
        
        set_country_flag = defensive_stratagem__$TYPE$
    }
    custom_tooltip = DEFENSIVE_STRATAGEM_$TYPE$_TT
}

set_insurrection_stratagem = {
    hidden_effect = {
        clr_country_flag = insurrection_stratagem__standard
        clr_country_flag = insurrection_stratagem__bribery
        clr_country_flag = insurrection_stratagem__compromise
        clr_country_flag = insurrection_stratagem__garrison

        set_country_flag = insurrection_stratagem__$TYPE$
    }
    
    custom_tooltip = INSURRECTION_STRATAGEM_$TYPE$_TT
}

take_offensive_stratagem_cost = {
    add_years_of_income = -1
    add_mil_power = -200
}

take_defensive_stratagem_cost = {
    add_years_of_income = -1
    add_mil_power = -200
}

take_insurrection_stratagem_cost = {
    add_years_of_income = -1
    add_mil_power = -200
}

show_stratagem_notification_event = {
    # Winner
    if = {
        limit = {
            NOT = { has_country_flag = stratagem_notification__$TYPE$ }
            is_at_war = yes
            FROM = {
                has_country_flag = $GROUP$_stratagem__$TYPE$
            }
        }
        FROM = {
            save_event_target_as = enemy_country
        }
        country_event = { id = wwu_stratagems.$ID$ }
    }
    
    # Loser
    if = {
        limit = {
            FROM = {
                NOT = { has_country_flag = stratagem_notification__$TYPE$ }
                is_at_war = yes
            }
            has_country_flag = $GROUP$_stratagem__$TYPE$
        }
        save_event_target_as = enemy_country
        
        FROM = { country_event = { id = wwu_stratagems.$ID$ } }
    }
}

show_stratagem_notifications = {
    #------------------
    # Offensive Stratagems
    #------------------
    # Sow Terror
    show_stratagem_notification_event = { 
        GROUP = offensive 
        TYPE = sow_terror           
        ID = 60 
    }
    # Slash and Burn
    show_stratagem_notification_event = { 
        GROUP = offensive 
        TYPE = slash_and_burn           
        ID = 61
    }
    
    # Enslavement
    show_stratagem_notification_event = { 
        GROUP = offensive 
        TYPE = enslavement           
        ID = 66
    }
    
    # Purification
    show_stratagem_notification_event = { 
        GROUP = offensive 
        TYPE = purification           
        ID = 67
    }
    
    #------------------
    # Defensive Stratagems
    #------------------
    # Martyrdom
    show_stratagem_notification_event = { 
        GROUP = defensive 
        TYPE = martyrdom           
        ID = 63
    }
    
    # Sabotage
    show_stratagem_notification_event = { 
        GROUP = defensive 
        TYPE = sabotage           
        ID = 64
    }
    
    # Slander
    show_stratagem_notification_event = { 
        GROUP = defensive 
        TYPE = slander           
        ID = 65
    }
}

# Sow Terror
sow_terror_stratagem = {
    if = {
        limit = {
            FROM = {
                has_offensive_stratagem__sow_terror = yes
            }
        }
        
        if = {
            limit = {
                FROM = {
                    mil_power = 10
                }
            }
            
            FROM = {
                add_mil_power = -10
            }
        
            every_neighbor_province = {
                limit = {   
                    # Only affect war enemies
                    owner = {
                        war_with = FROM
                    }
                    NOT = { fort_level = 1 }
                    NOT = { controlled_by = FROM }
                    controlled_by = owner # Affect only those owner still controls
                }
                
                change_controller = FROM
            }
        }
    }
}

# Slash and Burn
slash_and_burn_stratagem = {
    if = {
        limit = {
            FROM = {
                has_offensive_stratagem__slash_and_burn = yes
            }
            NOT = { owned_by = FROM } # Stop any issues where FROM re-sieges there own province, and applies devastation
        }
        
        if = {
            limit = {
                FROM = {
                    mil_power = 10
                }
            }
            
            FROM = {
                add_mil_power = -10
            }
        
            add_devastation = 50
        }
    }
}

# Enslavement
enslavement_stratagem = {
    if = {
        limit = {
            FROM = {
                has_offensive_stratagem__enslavement = yes
            }
            NOT = { owned_by = FROM } # Stop any issues where FROM re-sieges there own province, and applies devastation
        }
        
        if = {
            limit = {
                FROM = {
                    mil_power = 10
                }
            }
            
            FROM = {
                add_mil_power = -10
            }
            
            # Cascade, add manpower for each breakpoint
            if = {
                limit = {
                    development = 3
                }
                
                FROM = { add_manpower = 0.25 }
            }
            if = {
                limit = {
                    development = 6
                }
                
                FROM = { add_manpower = 0.25 }
            }
            if = {
                limit = {
                    development = 9
                }
                
                FROM = { add_manpower = 0.25 }
            }
            if = {
                limit = {
                    development = 12
                }
                
                FROM = { add_manpower = 0.25 }
            }
            if = {
                limit = {
                    development = 15
                }
                
                FROM = { add_manpower = 0.25 }
            }
            if = {
                limit = {
                    development = 18
                }
                
                FROM = { add_manpower = 0.25 }
            }
            if = {
                limit = {
                    development = 21
                }
                
                FROM = { add_manpower = 0.25 }
            }
            if = {
                limit = {
                    development = 24
                }
                
                FROM = { add_manpower = 0.25 }
            }
            if = {
                limit = {
                    development = 27
                }
                
                FROM = { add_manpower = 0.5 }
            }
            if = {
                limit = {
                    development = 30
                }
                
                FROM = { add_manpower = 0.5 }
            }
        }
    }
}

# Purification
purification_stratagem = {
    if = {
        limit = {
            FROM = {
                has_offensive_stratagem__purification = yes
            }
            NOT = { owned_by = FROM } # Stop any issues where FROM re-sieges there own province, and applies devastation
        }
        
        if = {
            limit = {
                is_capital = no
                NOT = { development = 10 }
                FROM = {
                    mil_power = 50
                }
            }
            
            FROM = {
                add_mil_power = -50
            }
        
            change_culture = FROM
            change_religion = FROM
            add_devastation = 25
        }
    }
}

# Martyrdom
martyrdom_stratagem = {
    if = {
        limit = {
            FROM = {
                has_defensive_stratagem__martyrdom = yes
            }
            # Don't trigger for self-sieges
            controller = {
                NOT = { tag = FROM }
            }
        }
        
        if = {
            limit = {
                FROM = {
                    mil_power = 5
                }
            }
            
            FROM = {
                add_mil_power = -5
            }
        
            controller = {
                add_manpower = -1
            }
        }
    }
}

# Sabotage
sabotage_stratagem = {
    if = {
        limit = {
            FROM = {
                has_defensive_stratagem__sabotage = yes
            }
            # Don't trigger for self-sieges
            controller = {
                NOT = { tag = FROM }
            }
        }
        
        if = {
            limit = {
                FROM = {
                    mil_power = 5
                }
                controller = {
                    treasury = 25
                }
            }
            
            FROM = {
                add_mil_power = -5
            }
        
            controller = {
                add_treasury = -25
            }
        }
    }
}

# Slander
slander_stratagem = {
    if = {
        limit = {
            FROM = {
                has_defensive_stratagem__slander = yes
            }
            # Don't trigger for self-sieges
            controller = {
                NOT = { tag = FROM }
            }
        }
        
        if = {
            limit = {
                FROM = {
                    mil_power = 5
                }
            }
            
            FROM = {
                add_mil_power = -5
            }
        
            controller = {
                add_prestige = -5
            }
        }
    }
}

# Bribery
bribery_stratagem = {
    if = {
        limit = {
            FROM = {
                has_insurrection_stratagem__bribery = yes
            }
            # Only trigger for rebels
            controller = {
                tag = REB
            }
        }
        
        if = {
            limit = {
                FROM = {
                    years_of_income = 0.1
                }
                
                # Cascading, scales the cost based on rebel stack size
                if = {
                    limit = {
                        units_in_province = 5
                    }
                    FROM = {
                        years_of_income = 0.15
                    }
                }
                if = {
                    limit = {
                        units_in_province = 10
                    }
                    FROM = {
                        years_of_income = 0.2
                    }
                }
                if = {
                    limit = {
                        units_in_province = 15
                    }
                    FROM = {
                        years_of_income = 0.25
                    }
                }
                if = {
                    limit = {
                        units_in_province = 20
                    }
                    FROM = {
                        years_of_income = 0.3
                    }
                }
                if = {
                    limit = {
                        units_in_province = 25
                    }
                    FROM = {
                        years_of_income = 0.35
                    }
                }
                if = {
                    limit = {
                        units_in_province = 30
                    }
                    FROM = {
                        years_of_income = 0.4
                    }
                }
                if = {
                    limit = {
                        units_in_province = 35
                    }
                    FROM = {
                        years_of_income = 0.45
                    }
                }
                if = {
                    limit = {
                        units_in_province = 40
                    }
                    FROM = {
                        years_of_income = 0.5
                    }
                }
            }
            
            FROM = {
                add_years_of_income = -0.1
            }
            # Cascading, scales the cost based on rebel stack size
            if = {
                limit = {
                    units_in_province = 5
                }
                FROM = {
                    add_years_of_income = -0.1
                }
            }
            if = {
                limit = {
                    units_in_province = 10
                }
                FROM = {
                    add_years_of_income = -0.1
                }
            }
            if = {
                limit = {
                    units_in_province = 15
                }
                FROM = {
                    add_years_of_income = -0.1
                }
            }
            if = {
                limit = {
                    units_in_province = 20
                }
                FROM = {
                    add_years_of_income = -0.1
                }
            }
            if = {
                limit = {
                    units_in_province = 25
                }
                FROM = {
                    add_years_of_income = -0.1
                }
            }
            if = {
                limit = {
                    units_in_province = 30
                }
                FROM = {
                    add_years_of_income = -0.1
                }
            }
            if = {
                limit = {
                    units_in_province = 35
                }
                FROM = {
                    add_years_of_income = -0.1
                }
            }
            if = {
                limit = {
                    units_in_province = 40
                }
                FROM = {
                    add_years_of_income = -0.1
                }
            }
            
            # Kill them
            province_event = { id = wwu_stratagems.50 days = 1 }
            province_event = { id = wwu_stratagems.51 days = 1 }
            
        }
    }
}

# Compromise
compromise_stratagem = {
    if = {
        limit = {
            FROM = {
                has_insurrection_stratagem__compromise = yes
            }
            # Only trigger for rebels
            controller = {
                tag = REB
            }
        }
        
        if = {
            limit = {
                FROM = {
                    NOT = { corruption = 24.8 }
                }
                # Cascading, scales the cost based on rebel stack size
                if = {
                    limit = {
                        units_in_province = 5
                    }
                    FROM = {
                        NOT = { corruption = 24.7 }
                    }
                }
                if = {
                    limit = {
                        units_in_province = 10
                    }
                    FROM = {
                        NOT = { corruption = 24.6 }
                    }
                }
                if = {
                    limit = {
                        units_in_province = 15
                    }
                    FROM = {
                        NOT = { corruption = 24.5 }
                    }
                }
                if = {
                    limit = {
                        units_in_province = 20
                    }
                    FROM = {
                        NOT = { corruption = 24.4 }
                    }
                }
                if = {
                    limit = {
                        units_in_province = 25
                    }
                    FROM = {
                        NOT = { corruption = 24.3 }
                    }
                }
                if = {
                    limit = {
                        units_in_province = 30
                    }
                    FROM = {
                        NOT = { corruption = 24.2 }
                    }
                }
                if = {
                    limit = {
                        units_in_province = 35
                    }
                    FROM = {
                        NOT = { corruption = 24.1 }
                    }
                }
                if = {
                    limit = {
                        units_in_province = 40
                    }
                    FROM = {
                        NOT = { corruption = 24 }
                    }
                }
            }
            
            FROM = {
                add_corruption = 0.2
            }
            # Cascading, scales the cost based on rebel stack size
            if = {
                limit = {
                    units_in_province = 5
                }
                FROM = {
                    add_corruption = 0.1
                }
            }
            if = {
                limit = {
                    units_in_province = 10
                }
                FROM = {
                    add_corruption = 0.1
                }
            }
            if = {
                limit = {
                    units_in_province = 15
                }
                FROM = {
                    add_corruption = 0.1
                }
            }
            if = {
                limit = {
                    units_in_province = 20
                }
                FROM = {
                    add_corruption = 0.1
                }
            }
            if = {
                limit = {
                    units_in_province = 25
                }
                FROM = {
                    add_corruption = 0.1
                }
            }
            if = {
                limit = {
                    units_in_province = 30
                }
                FROM = {
                    add_corruption = 0.1
                }
            }
            if = {
                limit = {
                    units_in_province = 35
                }
                FROM = {
                    add_corruption = 0.1
                }
            }
            if = {
                limit = {
                    units_in_province = 40
                }
                FROM = {
                    add_corruption = 0.1
                }
            }
            
            # Kill them
            province_event = { id = wwu_stratagems.50 days = 1 }
            province_event = { id = wwu_stratagems.51 days = 1 }
            
        }
    }
}

# Garrison
garrison_stratagem = {
    if = {
        limit = {
            FROM = {
                has_insurrection_stratagem__garrison = yes
            }
            # Only trigger for rebels
            controller = {
                tag = REB
            }
        }
        
        if = {
            limit = {
                FROM = {
                    manpower = 1
                }
                # Cascading, scales the cost based on rebel stack size
                if = {
                    limit = {
                        units_in_province = 5
                    }
                    FROM = {
                        manpower = 2
                    }
                }
                if = {
                    limit = {
                        units_in_province = 10
                    }
                    FROM = {
                        manpower = 3
                    }
                }
                if = {
                    limit = {
                        units_in_province = 15
                    }
                    FROM = {
                        manpower = 3
                    }
                }
                if = {
                    limit = {
                        units_in_province = 20
                    }
                    FROM = {
                        manpower = 4
                    }
                }
                if = {
                    limit = {
                        units_in_province = 25
                    }
                    FROM = {
                        manpower = 5
                    }
                }
                if = {
                    limit = {
                        units_in_province = 30
                    }
                    FROM = {
                        manpower = 6
                    }
                }
                if = {
                    limit = {
                        units_in_province = 35
                    }
                    FROM = {
                        manpower = 7
                    }
                }
                if = {
                    limit = {
                        units_in_province = 40
                    }
                    FROM = {
                        manpower = 8
                    }
                }
            }
            
            FROM = {
                add_manpower = -1.0
            }
            # Cascading, scales the cost based on rebel stack size
            if = {
                limit = {
                    units_in_province = 5
                }
                FROM = {
                    add_manpower = -1
                }
            }
            if = {
                limit = {
                    units_in_province = 10
                }
                FROM = {
                    add_manpower = -1
                }
            }
            if = {
                limit = {
                    units_in_province = 15
                }
                FROM = {
                    add_manpower = -1
                }
            }
            if = {
                limit = {
                    units_in_province = 20
                }
                FROM = {
                    add_manpower = -1
                }
            }
            if = {
                limit = {
                    units_in_province = 25
                }
                FROM = {
                    add_manpower = -1
                }
            }
            if = {
                limit = {
                    units_in_province = 30
                }
                FROM = {
                    add_manpower = -1
                }
            }
            if = {
                limit = {
                    units_in_province = 35
                }
                FROM = {
                    add_manpower = -1
                }
            }
            if = {
                limit = {
                    units_in_province = 40
                }
                FROM = {
                    add_manpower = -1
                }
            }
            
            # Kill them
            province_event = { id = wwu_stratagems.50 days = 1 }
            province_event = { id = wwu_stratagems.51 days = 1 }
            
        }
    }
}