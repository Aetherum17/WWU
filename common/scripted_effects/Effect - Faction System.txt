#--------------------------
# Factions
#--------------------------
# alliance
# horde
# old_horde
# trade_coalition
# dragon_aspects

#-----------------------------------
# On Actions
#-----------------------------------
# ROOT = Winning Country, FROM = Losing Country
on_battle_won_country__faction = {
    # Faction: Alliance Fervor
    if = {
        limit = {
            has_country_modifier = member_of_alliance
            FROM = {
                OR = {
                    has_country_modifier = member_of_horde
                    has_country_modifier = member_of_old_horde
                }
            }
        }
        
        add_country_modifier = {
            name = factional_fervor
            duration = 365
        }
    }

    # Faction: Horde Fervor
    if = {
        limit = {
            OR = {
                has_country_modifier = member_of_horde
                has_country_modifier = member_of_old_horde
            }
            FROM = {
                has_country_modifier = member_of_alliance
            }
        }
        
        add_country_modifier = {
            name = factional_fervor
            duration = 365
        }
    }
}

# ROOT = Country
on_monarch_death__faction = {
    if = {
        limit = {
            has_country_modifier = head_of_old_horde
        }
        
        country_event = { id = wwu_faction_system.20 }
    }
    
    if = {
        limit = {
            has_country_modifier = head_of_horde
        }
        
        country_event = { id = wwu_faction_system.21 }
    }
}

# ROOT = Country, FROM = Annexed Country
on_annexed__faction = {
    # If Head of faction is annexed, re-assign leadership
    if = {
        limit = {   
            NOT = { has_global_flag = alliance_dismantled }
            FROM = {
                has_country_modifier = head_of_alliance
            }
        }
        country_event = { id = wwu_faction_system.30 }
    }
    if = {
        limit = {
            NOT = { has_global_flag = old_horde_dismantled }
            FROM = {
                has_country_modifier = head_of_old_horde
            }
        }
        country_event = { id = wwu_faction_system.31 }
    }
    if = {
        limit = {
            NOT = { has_global_flag = horde_dismantled }
            FROM = {
                has_country_modifier = head_of_horde
            }
        }
        country_event = { id = wwu_faction_system.32 }
    }
    if = {
        limit = {
            NOT = { has_global_flag = trade_coalition_dismantled }
            FROM = {
                has_country_modifier = head_of_trade_coalition
            }
        }
        country_event = { id = wwu_faction_system.33 }
    }
    if = {
        limit = {
            NOT = { has_global_flag = dragon_aspects_dismantled }
            FROM = {
                has_country_modifier = head_of_dragon_aspects
            }
        }
        country_event = { id = wwu_faction_system.34 }
    }
}

on_monthly_pulse__faction = {
    # Add these fallback checks in-case the X_exists flag is missed.
    if = {
        limit = {
            NOT = { has_global_flag = alliance_exists }
            any_country = {
                has_country_modifier = head_of_alliance
            }
        }
        
        set_global_flag = alliance_exists
    }
    if = {
        limit = {
            NOT = { has_global_flag = old_horde_exists }
            any_country = {
                has_country_modifier = head_of_old_horde
            }
        }
        
        set_global_flag = old_horde_exists
    }
    if = {
        limit = {
            NOT = { has_global_flag = horde_exists }
            any_country = {
                has_country_modifier = head_of_horde
            }
        }
        
        set_global_flag = horde_exists
    }
    if = {
        limit = {
            NOT = { has_global_flag = trade_coalition_exists }
            any_country = {
                has_country_modifier = head_of_trade_coalition
            }
        }
        
        set_global_flag = trade_coalition_exists
    }
    if = {
        limit = {
            NOT = { has_global_flag = dragon_aspects_exists }
            any_country = {
                has_country_modifier = head_of_dragon_aspects
            }
        }
        
        set_global_flag = dragon_aspects_exists
    }
    
    # Clean up members if Faction is collapsed
    # Alliance
    if = {
        limit = {
            has_global_flag = alliance_dismantled
            has_country_modifier = head_of_alliance
        }
        
        remove_country_modifier = head_of_alliance
    }
    if = {
        limit = {
            has_global_flag = alliance_dismantled
            has_country_modifier = member_of_alliance
        }
        
        remove_country_modifier = member_of_alliance
    }
    # Old Horde
    if = {
        limit = {
            has_global_flag = old_horde_dismantled
            has_country_modifier = head_of_old_horde
        }
        
        remove_country_modifier = head_of_old_horde
    }
    if = {
        limit = {
            has_global_flag = old_horde_dismantled
            has_country_modifier = member_of_old_horde
        }
        
        remove_country_modifier = member_of_old_horde
    }
    # Horde
    if = {
        limit = {
            has_global_flag = horde_dismantled
            has_country_modifier = head_of_horde
        }
        
        remove_country_modifier = head_of_horde
    }
    if = {
        limit = {
            has_global_flag = horde_dismantled
            has_country_modifier = member_of_horde
        }
        
        remove_country_modifier = member_of_horde
    }
    # Trade Coalition
    if = {
        limit = {
            has_global_flag = trade_coalition_dismantled
            has_country_modifier = head_of_trade_coalition
        }
        
        remove_country_modifier = head_of_trade_coalition
    }
    if = {
        limit = {
            has_global_flag = trade_coalition_dismantled
            has_country_modifier = member_of_trade_coalition
        }
        
        remove_country_modifier = member_of_trade_coalition
    }
    # Dragon Aspects
    if = {
        limit = {
            has_global_flag = dragon_aspects_dismantled
            has_country_modifier = head_of_dragon_aspects
        }
        
        remove_country_modifier = head_of_dragon_aspects
    }
    if = {
        limit = {
            has_global_flag = dragon_aspects_dismantled
            has_country_modifier = member_of_dragon_aspects
        }
        
        remove_country_modifier = member_of_dragon_aspects
    }
    
    # War Support
    if = {
        limit = {
            NOT = { has_country_flag = war_support_faction_leader }
            OR = {
                AND = {
                    has_country_modifier = head_of_alliance
                    has_government_mechanic = faction_authority_alliance_mechanic
                    is_at_war = yes
                  
                    any_country = {
                        has_country_modifier = member_of_alliance
                        
                        OR = {
                            is_in_war = {
                                attackers = THIS
                                attackers = ROOT
                            }
                            is_in_war = {
                                defenders = THIS
                                defenders = ROOT
                            }
                        }
                    }
                }
                AND = {
                    has_country_modifier = head_of_horde
                    has_government_mechanic = faction_authority_horde_mechanic
                    is_at_war = yes
                  
                    any_country = {
                        has_country_modifier = member_of_horde
                        
                        OR = {
                            is_in_war = {
                                attackers = THIS
                                attackers = ROOT
                            }
                            is_in_war = {
                                defenders = THIS
                                defenders = ROOT
                            }
                        }
                    }
                }
                AND = {
                    has_country_modifier = head_of_old_horde
                    has_government_mechanic = faction_authority_old_horde_mechanic
                    is_at_war = yes
                  
                    any_country = {
                        has_country_modifier = member_of_old_horde
                        
                        OR = {
                            is_in_war = {
                                attackers = THIS
                                attackers = ROOT
                            }
                            is_in_war = {
                                defenders = THIS
                                defenders = ROOT
                            }
                        }
                    }
                }
                AND = {
                    has_country_modifier = head_of_trade_coalition
                    has_government_mechanic = faction_authority_trade_coalition_mechanic
                    is_at_war = yes
                  
                    any_country = {
                        has_country_modifier = member_of_trade_coalition
                        
                        OR = {
                            is_in_war = {
                                attackers = THIS
                                attackers = ROOT
                            }
                            is_in_war = {
                                defenders = THIS
                                defenders = ROOT
                            }
                        }
                    }
                }
            }
        }
        
        set_country_flag = war_support_faction_leader
    }
}

on_yearly_pulse__faction = {
    #------------
    # Decisions
    #------------
    # The heavy checks are done here (once per year) to reduce load, as checking directly in the
    # decision has a heavier effect on performance.
    
    # Establish the Alliance
    if = {
        limit = {
            ai = no
            has_global_flag = enabled_faction_mechanics
            NOT = { has_global_flag = allow_establish_the_alliance }
            NOT = { has_global_flag = alliance_dismantled }
            NOT = { has_global_flag = setup_the_alliance }
        }
        
        if = {
            limit = {
                continent_eastern_kingdoms = {
                    culture_group = culture_group_orc
                }
                
                # Check if any land in these regions is Orc or Ogre, i.e. Old Horde has invaded
                OR = {
                    region_swamp_of_sorrows = {
                        OR = {
                            culture_group = culture_group_orc
                            culture_group = culture_group_ogre
                        }
                    }
                    region_blasted_lands = {
                        OR = {
                            culture_group = culture_group_orc
                            culture_group = culture_group_ogre
                        }
                    }
                }
            }
            
            set_global_flag = allow_establish_the_alliance
        }
    }

    #------------
    # Faction Authority
    #------------
    if = {
        limit = {
            OR = {
                AND = {
                    has_government_mechanic = faction_authority_alliance_mechanic
                    has_country_modifier = head_of_alliance
                    
                    any_country = {
                        has_country_modifier = member_of_alliance
                        has_opinion = {
                            who = ROOT
                            value = 180
                        }
                    }
                }
                AND = {
                    has_government_mechanic = faction_authority_horde_mechanic
                    has_country_modifier = head_of_horde
                    
                    any_country = {
                        has_country_modifier = member_of_horde
                        has_opinion = {
                            who = ROOT
                            value = 180
                        }
                    }
                }
                AND = {
                    has_government_mechanic = faction_authority_old_horde_mechanic
                    has_country_modifier = head_of_old_horde
                    
                    any_country = {
                        has_country_modifier = member_of_old_horde
                        has_opinion = {
                            who = ROOT
                            value = 180
                        }
                    }
                }
                AND = {
                    has_government_mechanic = faction_authority_trade_coalition_mechanic
                    has_country_modifier = head_of_trade_coalition
                    
                    any_country = {
                        has_country_modifier = member_of_trade_coalition
                        has_opinion = {
                            who = ROOT
                            value = 180
                        }
                    }
                }
            }
        }
        
        if = {
            limit = {
                has_government_mechanic = faction_authority_alliance_mechanic
            }
            add_government_power = {
                mechanic_type = faction_authority_alliance_mechanic
                power_type = faction_authority_alliance
                value = 5
            }
        }
        if = {
            limit = {
                has_government_mechanic = faction_authority_horde_mechanic
            }
            add_government_power = {
                mechanic_type = faction_authority_horde_mechanic
                power_type = faction_authority_horde
                value = 5
            }
        }
        if = {
            limit = {
                has_government_mechanic = faction_authority_old_horde_mechanic
            }
            add_government_power = {
                mechanic_type = faction_authority_old_horde_mechanic
                power_type = faction_authority_old_horde
                value = 5
            }
        }
        if = {
            limit = {
                has_government_mechanic = faction_authority_trade_coalition_mechanic
            }
            add_government_power = {
                mechanic_type = faction_authority_trade_coalition_mechanic
                power_type = faction_authority_trade_coalition
                value = 5
            }
        }
    }
    
    if = {
        limit = {
            has_global_flag = enabled_faction_mechanics
        }
        
        #------------
        # Faction Leader Assignment
        #------------
        # Alliance
        if = {
            limit = {
                NOT = { has_global_flag = leader_assignment_in_progress }
                NOT = { has_global_flag = alliance_dismantled }
                has_global_flag = alliance_exists
                
                has_country_modifier = member_of_alliance
                NOT = { has_country_modifier = head_of_alliance }
                
                calc_true_if = {
                    amount = 2
                    all_country = {
                        has_country_modifier = member_of_alliance
                    }
                }
                all_country = {
                    NOT = { has_country_modifier = head_of_alliance }
                }
            }
            
            set_global_flag = leader_assignment_in_progress
            random_country = {
                limit = {
                    has_country_modifier = member_of_alliance
                    NOT = { has_country_modifier = recent_leader_assignment }
                }
                
                country_event = { id = wwu_faction_system_leader_assignment.10 }
            }
        }
        # Old Horde
        if = {
            limit = {
                NOT = { has_global_flag = leader_assignment_in_progress }
                NOT = { has_global_flag = old_horde_dismantled }
                has_global_flag = old_horde_exists
                
                has_country_modifier = member_of_old_horde
                NOT = { has_country_modifier = head_of_old_horde }
                
                calc_true_if = {
                    amount = 2
                    all_country = {
                        has_country_modifier = member_of_old_horde
                    }
                }
                
                all_country = {
                    NOT = { has_country_modifier = head_of_old_horde }
                }
            }
            
            set_global_flag = leader_assignment_in_progress
            random_country = {
                limit = {
                    has_country_modifier = member_of_old_horde
                    NOT = { has_country_modifier = recent_leader_assignment }
                }
                
                country_event = { id = wwu_faction_system_leader_assignment.12 }
            }
        }
        # Horde
        if = {
            limit = {
                NOT = { has_global_flag = leader_assignment_in_progress }
                NOT = { has_global_flag = horde_dismantled }
                has_global_flag = horde_exists
                
                has_country_modifier = member_of_horde
                NOT = { has_country_modifier = head_of_horde }
                
                calc_true_if = {
                    amount = 2
                    all_country = {
                        has_country_modifier = member_of_horde
                    }
                }
                
                all_country = {
                    NOT = { has_country_modifier = head_of_horde }
                }
            }   
            
            set_global_flag = leader_assignment_in_progress
            random_country = {
                limit = {
                    has_country_modifier = member_of_horde
                    NOT = { has_country_modifier = recent_leader_assignment }
                }
                
                country_event = { id = wwu_faction_system_leader_assignment.11 }
            }
        }
        # Trade Coalition
        if = {
            limit = {
                NOT = { has_global_flag = leader_assignment_in_progress }
                NOT = { has_global_flag = trade_coalition_dismantled }
                has_global_flag = trade_coalition_exists
                
                has_country_modifier = member_of_trade_coalition
                NOT = { has_country_modifier = head_of_trade_coalition }
                
                calc_true_if = {
                    amount = 2
                    all_country = {
                        has_country_modifier = member_of_trade_coalition
                    }
                }
                
                all_country = {
                    NOT = { has_country_modifier = head_of_trade_coalition }
                }
            }   
            
            set_global_flag = leader_assignment_in_progress
            random_country = {
                limit = {
                    has_country_modifier = member_of_trade_coalition
                    NOT = { has_country_modifier = recent_leader_assignment }
                }
                
                country_event = { id = wwu_faction_system_leader_assignment.13 }
            }
        }
        # Dragon Aspects
        if = {
            limit = {
                NOT = { has_global_flag = leader_assignment_in_progress }
                NOT = { has_global_flag = dragon_aspects_dismantled }
                has_global_flag = dragon_aspects_exists
                
                has_country_modifier = member_of_dragon_aspects
                NOT = { has_country_modifier = head_of_dragon_aspects }
                
                calc_true_if = {
                    amount = 2
                    all_country = {
                        has_country_modifier = member_of_dragon_aspects
                    }
                }
                
                all_country = {
                    NOT = { has_country_modifier = head_of_dragon_aspects }
                }
            }
            
            set_global_flag = leader_assignment_in_progress
            random_country = {
                limit = {
                    has_country_modifier = member_of_dragon_aspects
                    NOT = { has_country_modifier = recent_leader_assignment }
                }
                
                country_event = { id = wwu_faction_system_leader_assignment.14 }
            }
        }
    }
}

#--------------------------
# Utility
#--------------------------
set_head_of_faction = {
    if = {
        limit = {
            any_country = {
                has_country_modifier = head_of_$faction$
            }
        }
        every_country = {
            limit = {
                has_country_modifier = head_of_$faction$
            }
            remove_country_modifier = head_of_$faction$
        }
    }
    add_country_modifier = {
        name = head_of_$faction$
        duration = -1
    }
}

set_member_of_faction = {
    add_country_modifier = {
        name = member_of_$faction$
        duration = -1
    }
}

destroy_faction = {
    every_country = {
        remove_country_modifier = head_of_$faction$
        remove_country_modifier = member_of_$faction$
    }
    clr_global_flag = $faction$_exists
}

build_faction_roster = {
    every_country = {
        limit = {
            has_country_modifier = head_of_$FACTION$
        }
        save_event_target_as = faction_leader
    }
    
    every_country = {
        limit = {
            has_country_modifier = member_of_$FACTION$
        }
        
        if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_1 }
            }
            
            save_event_target_as = faction_member_1
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_2 }
            }
            
            save_event_target_as = faction_member_2
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_3 }
            }
            
            save_event_target_as = faction_member_3
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_4 }
            }
            
            save_event_target_as = faction_member_4
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_5 }
            }
            
            save_event_target_as = faction_member_5
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_6 }
            }
            
            save_event_target_as = faction_member_6
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_7 }
            }
            
            save_event_target_as = faction_member_7
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_8 }
            }
            
            save_event_target_as = faction_member_8
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_9 }
            }
            
            save_event_target_as = faction_member_9
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_10 }
            }
            
            save_event_target_as = faction_member_10
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_11 }
            }
            
            save_event_target_as = faction_member_11
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_12 }
            }
            
            save_event_target_as = faction_member_12
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_13 }
            }
            
            save_event_target_as = faction_member_13
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_14 }
            }
            
            save_event_target_as = faction_member_14
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_15 }
            }
            
            save_event_target_as = faction_member_15
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_16 }
            }
            
            save_event_target_as = faction_member_16
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_17 }
            }
            
            save_event_target_as = faction_member_17
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_18 }
            }
            
            save_event_target_as = faction_member_18
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_19 }
            }
            
            save_event_target_as = faction_member_19
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_20 }
            }
            
            save_event_target_as = faction_member_20
        }
    }
}

open_alliance_view = {
    hidden_effect = {
        clr_country_flag = gui_flag__open_alliance_view
        clr_country_flag = gui_flag__open_old_horde_view
        clr_country_flag = gui_flag__open_horde_view
        clr_country_flag = gui_flag__open_trade_coalition_view
        clr_country_flag = gui_flag__open_dragon_aspects_view
        
    
        set_country_flag = gui_flag__open_alliance_view
    }
}
close_alliance_view = {
    hidden_effect = {
        clr_country_flag = gui_flag__open_alliance_view
    }
}

open_old_horde_view = {
    hidden_effect = {
        clr_country_flag = gui_flag__open_alliance_view
        clr_country_flag = gui_flag__open_old_horde_view
        clr_country_flag = gui_flag__open_horde_view
        clr_country_flag = gui_flag__open_trade_coalition_view
        clr_country_flag = gui_flag__open_dragon_aspects_view
        
        set_country_flag = gui_flag__open_old_horde_view
    }
}
close_old_horde_view = {
    hidden_effect = {
        clr_country_flag = gui_flag__open_old_horde_view
    }
}

open_horde_view = {
    hidden_effect = {
        clr_country_flag = gui_flag__open_alliance_view
        clr_country_flag = gui_flag__open_old_horde_view
        clr_country_flag = gui_flag__open_horde_view
        clr_country_flag = gui_flag__open_trade_coalition_view
        clr_country_flag = gui_flag__open_dragon_aspects_view
        
        set_country_flag = gui_flag__open_horde_view
    }
}
close_horde_view = {
    hidden_effect = {
        clr_country_flag = gui_flag__open_horde_view
    }
}

open_trade_coalition_view = {
    hidden_effect = {
        clr_country_flag = gui_flag__open_alliance_view
        clr_country_flag = gui_flag__open_old_horde_view
        clr_country_flag = gui_flag__open_horde_view
        clr_country_flag = gui_flag__open_trade_coalition_view
        clr_country_flag = gui_flag__open_dragon_aspects_view
        
        set_country_flag = gui_flag__open_trade_coalition_view
    }
}
close_trade_coalition_view = {
    hidden_effect = {
        clr_country_flag = gui_flag__open_trade_coalition_view
    }
}

open_dragon_aspects_view = {
    hidden_effect = {
        clr_country_flag = gui_flag__open_alliance_view
        clr_country_flag = gui_flag__open_old_horde_view
        clr_country_flag = gui_flag__open_horde_view
        clr_country_flag = gui_flag__open_trade_coalition_view
        clr_country_flag = gui_flag__open_dragon_aspects_view
        
        set_country_flag = gui_flag__open_dragon_aspects_view
    }
}
close_dragon_aspects_view = {
    hidden_effect = {
        clr_country_flag = gui_flag__open_dragon_aspects_view
    }
}