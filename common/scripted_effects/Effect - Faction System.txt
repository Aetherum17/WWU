#--------------------------
# Factions
#--------------------------
# alliance
# horde
# old_horde
# trade_coalition
# dragon_aspects

#--------------------------
# Utility
#--------------------------
set_head_of_faction = {
    if = {
        limit = {
            any_country = {
                has_country_modifier = head_of_$faction$
            }
        }
        every_country = {
            limit = {
                has_country_modifier = head_of_$faction$
            }
            remove_country_modifier = head_of_$faction$
        }
    }
    add_country_modifier = {
        name = head_of_$faction$
        duration = -1
    }
}

set_member_of_faction = {
    add_country_modifier = {
        name = member_of_$faction$
        duration = -1
    }
}

destroy_faction = {
    every_country = {
        remove_country_modifier = head_of_$faction$
        remove_country_modifier = member_of_$faction$
    }
    clr_global_flag = $faction$_exists
}

#-----------------------------------
# On Actions
#-----------------------------------
# ROOT = Winning Country, FROM = Losing Country
on_battle_won_country__faction = {
    # Faction: Alliance Fervor
    if = {
        limit = {
            has_country_modifier = member_of_alliance
            FROM = {
                OR = {
                    has_country_modifier = member_of_horde
                    has_country_modifier = member_of_old_horde
                }
            }
        }
        
        add_country_modifier = {
            name = factional_fervor
            duration = 365
        }
    }

    # Faction: Horde Fervor
    if = {
        limit = {
            OR = {
                has_country_modifier = member_of_horde
                has_country_modifier = member_of_old_horde
            }
            FROM = {
                has_country_modifier = member_of_alliance
            }
        }
        
        add_country_modifier = {
            name = factional_fervor
            duration = 365
        }
    }
}

# ROOT = Country
on_monarch_death__faction = {
    if = {
        limit = {
            has_country_modifier = head_of_old_horde
        }
        
        country_event = { id = wwu_faction_system.20 }
    }
    
    if = {
        limit = {
            has_country_modifier = head_of_horde
        }
        
        country_event = { id = wwu_faction_system.21 }
    }
}

# ROOT = Country, FROM = Annexed Country
on_annexed__faction = {
    # If Head of faction is annexed, re-assign leadership
    if = {
        limit = {   
            NOT = { has_global_flag = alliance_dismantled }
            FROM = {
                has_country_modifier = head_of_alliance
            }
        }
        country_event = { id = wwu_faction_system.30 }
    }
    if = {
        limit = {
            NOT = { has_global_flag = old_horde_dismantled }
            FROM = {
                has_country_modifier = head_of_old_horde
            }
        }
        country_event = { id = wwu_faction_system.31 }
    }
    if = {
        limit = {
            NOT = { has_global_flag = horde_dismantled }
            FROM = {
                has_country_modifier = head_of_horde
            }
        }
        country_event = { id = wwu_faction_system.32 }
    }
    if = {
        limit = {
            NOT = { has_global_flag = trade_coalition_dismantled }
            FROM = {
                has_country_modifier = head_of_trade_coalition
            }
        }
        country_event = { id = wwu_faction_system.33 }
    }
    if = {
        limit = {
            NOT = { has_global_flag = dragon_aspects_dismantled }
            FROM = {
                has_country_modifier = head_of_dragon_aspects
            }
        }
        country_event = { id = wwu_faction_system.34 }
    }
}

on_monthly_pulse__faction = {
    # Add these fallback checks in-case the X_exists flag is missed.
    if = {
        limit = {
            NOT = { has_global_flag = alliance_exists }
            any_country = {
                has_country_modifier = head_of_alliance
            }
        }
        
        set_global_flag = alliance_exists
    }
    if = {
        limit = {
            NOT = { has_global_flag = old_horde_exists }
            any_country = {
                has_country_modifier = head_of_old_horde
            }
        }
        
        set_global_flag = old_horde_exists
    }
    if = {
        limit = {
            NOT = { has_global_flag = horde_exists }
            any_country = {
                has_country_modifier = head_of_horde
            }
        }
        
        set_global_flag = horde_exists
    }
    if = {
        limit = {
            NOT = { has_global_flag = trade_coalition_exists }
            any_country = {
                has_country_modifier = head_of_trade_coalition
            }
        }
        
        set_global_flag = trade_coalition_exists
    }
    if = {
        limit = {
            NOT = { has_global_flag = dragon_aspects_exists }
            any_country = {
                has_country_modifier = head_of_dragon_aspects
            }
        }
        
        set_global_flag = dragon_aspects_exists
    }
    
    # Clean up members if Faction is collapsed
    # Alliance
    if = {
        limit = {
            has_global_flag = alliance_dismantled
            has_country_modifier = head_of_alliance
        }
        
        remove_country_modifier = head_of_alliance
    }
    if = {
        limit = {
            has_global_flag = alliance_dismantled
            has_country_modifier = member_of_alliance
        }
        
        remove_country_modifier = member_of_alliance
    }
    # Old Horde
    if = {
        limit = {
            has_global_flag = old_horde_dismantled
            has_country_modifier = head_of_old_horde
        }
        
        remove_country_modifier = head_of_old_horde
    }
    if = {
        limit = {
            has_global_flag = old_horde_dismantled
            has_country_modifier = member_of_old_horde
        }
        
        remove_country_modifier = member_of_old_horde
    }
    # Horde
    if = {
        limit = {
            has_global_flag = horde_dismantled
            has_country_modifier = head_of_horde
        }
        
        remove_country_modifier = head_of_horde
    }
    if = {
        limit = {
            has_global_flag = horde_dismantled
            has_country_modifier = member_of_horde
        }
        
        remove_country_modifier = member_of_horde
    }
    # Trade Coalition
    if = {
        limit = {
            has_global_flag = trade_coalition_dismantled
            has_country_modifier = head_of_trade_coalition
        }
        
        remove_country_modifier = head_of_trade_coalition
    }
    if = {
        limit = {
            has_global_flag = trade_coalition_dismantled
            has_country_modifier = member_of_trade_coalition
        }
        
        remove_country_modifier = member_of_trade_coalition
    }
    # Dragon Aspects
    if = {
        limit = {
            has_global_flag = dragon_aspects_dismantled
            has_country_modifier = head_of_dragon_aspects
        }
        
        remove_country_modifier = head_of_dragon_aspects
    }
    if = {
        limit = {
            has_global_flag = dragon_aspects_dismantled
            has_country_modifier = member_of_dragon_aspects
        }
        
        remove_country_modifier = member_of_dragon_aspects
    }
}



#--------------------------
# Roster
#--------------------------
build_faction_roster = {
    every_country = {
        limit = {
            has_country_modifier = head_of_$FACTION$
        }
        save_event_target_as = faction_leader
    }
    
    every_country = {
        limit = {
            has_country_modifier = member_of_$FACTION$
        }
        
        if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_1 }
            }
            
            save_event_target_as = faction_member_1
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_2 }
            }
            
            save_event_target_as = faction_member_2
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_3 }
            }
            
            save_event_target_as = faction_member_3
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_4 }
            }
            
            save_event_target_as = faction_member_4
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_5 }
            }
            
            save_event_target_as = faction_member_5
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_6 }
            }
            
            save_event_target_as = faction_member_6
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_7 }
            }
            
            save_event_target_as = faction_member_7
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_8 }
            }
            
            save_event_target_as = faction_member_8
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_9 }
            }
            
            save_event_target_as = faction_member_9
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_10 }
            }
            
            save_event_target_as = faction_member_10
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_11 }
            }
            
            save_event_target_as = faction_member_11
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_12 }
            }
            
            save_event_target_as = faction_member_12
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_13 }
            }
            
            save_event_target_as = faction_member_13
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_14 }
            }
            
            save_event_target_as = faction_member_14
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_15 }
            }
            
            save_event_target_as = faction_member_15
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_16 }
            }
            
            save_event_target_as = faction_member_16
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_17 }
            }
            
            save_event_target_as = faction_member_17
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_18 }
            }
            
            save_event_target_as = faction_member_18
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_19 }
            }
            
            save_event_target_as = faction_member_19
        }
        else_if = {
            limit = {
                NOT = { has_saved_event_target = faction_member_20 }
            }
            
            save_event_target_as = faction_member_20
        }
    }
}

