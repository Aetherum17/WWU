namespace = wwu_magic_report

# Magic Report
country_event = {
	id = wwu_magic_report.1
	title = wwu_magic_report.1.title
	desc = wwu_magic_report.1.desc
	picture = MAGIC_TOME_eventPicture
	
	is_triggered_only = yes
    
    # Undergo Magical Training
    option = {
		name = wwu_magic_report.1.option.magical_training
        
        trigger = {
            NOT = { has_country_modifier = ruler_investment_cooldown }
            has_global_flag = enabled_magic_mechanics
            NOT = { has_ruler_modifier = spellcaster_capabilities }
            NOT = { has_ruler_modifier = magical_training }
            
            if = {
                limit = {
                    OR = {
                        has_ruler_flag = mage_personality
                        has_ruler_flag = priest_personality
                        has_ruler_flag = warlock_personality
                        has_ruler_flag = druid_personality
                    }
                }
                
                adm_power = 40
                dip_power = 40
                mil_power = 40
            }
            else_if = {
                limit = {
                    has_reform = wwu_magic_free_magic
                }
                
                adm_power = 20
                dip_power = 20
                mil_power = 20
            }
            else = {
                adm_power = 60
                dip_power = 60
                mil_power = 60
            }
        }
        
        if = {
            limit = {
                OR = {
                    has_ruler_flag = mage_personality
                    has_ruler_flag = priest_personality
                    has_ruler_flag = warlock_personality
                    has_ruler_flag = druid_personality
                }
            }
            
            add_adm_power = -40
            add_dip_power = -40
            add_mil_power = -40
        }
        else_if = {
            limit = {
                has_reform = wwu_magic_free_magic
            }
            
            add_adm_power = -20
            add_dip_power = -20
            add_mil_power = -20
        }
        else = {
            add_adm_power = -60
            add_dip_power = -60
            add_mil_power = -60
        }
        
        add_ruler_modifier = {
            name = magical_training
            duration = 3650
        }
        
        custom_tooltip = MAGIC_UNDERGO_TRAINING
        
        # Play failure event if the ruler isn't a spellcaster by the end
        hidden_effect = {
            country_event = { id = wwu_magic.12 days = 3650 }
        }
        
        custom_tooltip = RULER_INVESTMENT_DURATION_TT
        hidden_effect = {
            add_country_modifier = {
                name = ruler_investment_cooldown
                duration = 1800
                hidden = yes
            }
        }
        
        # Add free points based on monarch skill
        # Only do it for the first instance of the decision
        hidden_effect = {
            if = {
                limit = {
                    is_variable_equal = {
                        which = ruler_magic_training
                        value = 0
                    }
                }
                if = {
                    limit = {
                        adm = 5
                    }
                    add_magical_training_point = yes
                }
                if = {
                    limit = {
                        dip = 5
                    }
                    add_magical_training_point = yes
                }
                if = {
                    limit = {
                        mil = 5
                    }
                    add_magical_training_point = yes
                }
            }
        }
        
        ai_chance = {
            factor = 1
            
            modifier = {
                factor = 0
                
                NOT = { adm_power = 300 }
                NOT = { dip_power = 300 }
                NOT = { mil_power = 300 }
            }
        }
	}
    
    # Undergo Magical Training - Lack Requirements
    option = {
		name = wwu_magic_report.1.option.magical_training.lack_requirement
        
        trigger = {
            NOT = { has_country_modifier = ruler_investment_cooldown }
            has_global_flag = enabled_magic_mechanics
            NOT = { has_ruler_modifier = spellcaster_capabilities }
            NOT = { has_ruler_modifier = magical_training }
            
            if = {
                limit = {
                    OR = {
                        has_ruler_flag = mage_personality
                        has_ruler_flag = priest_personality
                        has_ruler_flag = warlock_personality
                        has_ruler_flag = druid_personality
                    }
                }
                
                OR = {
                    NOT = { adm_power = 40 }
                    NOT = { dip_power = 40 }
                    NOT = { mil_power = 40 }
                }
            }
            else_if = {
                limit = {
                    has_reform = wwu_magic_free_magic
                }
                
                OR = {
                    NOT = { adm_power = 20 }
                    NOT = { dip_power = 20 }
                    NOT = { mil_power = 20 }
                }
            }
            else = {
                OR = {
                    NOT = { adm_power = 60 }
                    NOT = { dip_power = 60 }
                    NOT = { mil_power = 60 }
                }
            }
        }
        
        if = {
            limit = {
                OR = {
                    has_ruler_flag = mage_personality
                    has_ruler_flag = priest_personality
                    has_ruler_flag = warlock_personality
                    has_ruler_flag = druid_personality
                }
            }
            
            custom_tooltip = NEED_MAGICAL_TRAINING_REQUIREMENT_MAGE
        }
        else_if = {
            limit = {
                has_reform = wwu_magic_free_magic
            }
            
            custom_tooltip = NEED_MAGICAL_TRAINING_REQUIREMENT_DALARAN
        }
        else = {
            custom_tooltip = NEED_MAGICAL_TRAINING_REQUIREMENT
        }
        
        ai_chance = {
            factor = 0
        }
	}
    
    # Select Magic Specialization
    option = {
		name = wwu_magic_report.1.option.ruler_magic_specialization
        
        trigger = {
            has_global_flag = enabled_magic_mechanics
			has_country_flag = allow_magic_specialization_decision
        }
        
        hidden_effect = {
            clr_country_flag = allow_magic_specialization_decision
        }
        country_event = { id = wwu_magic.16 }
        
        ai_chance = {
            factor = 0
        }
	}
    
    # Improve Magical Skill
    option = {
		name = wwu_magic_report.1.option.magical_skill_training
        
        trigger = {
            NOT = { has_country_modifier = ruler_investment_cooldown }
            has_global_flag = enabled_magic_mechanics
            has_ruler_modifier = spellcaster_capabilities
            NOT = { has_ruler_modifier = recently_trained_magic }
        }
        
        hidden_effect = {
            set_country_flag = skip_status_report_return
        }
        
        country_event = { id = wwu_magic.60 }
        
        custom_tooltip = RULER_INVESTMENT_DURATION_TT
        hidden_effect = {
            add_country_modifier = {
                name = ruler_investment_cooldown
                duration = 1800
                hidden = yes
            }
        }
        
        ai_chance = {
            factor = 1
            
            modifier = {
                factor = 0
                
                NOT = { adm_power = 300 }
                NOT = { dip_power = 300 }
                NOT = { mil_power = 300 }
            }
        }
	}
    
    
    option = {
		name = wwu_magic_report.1.option.exit
        
        ai_chance = {
            factor = 1
        }
	}
    
    after = {
        if = {
            limit = {
                has_country_flag = skip_status_report_return
            }
            
            clr_country_flag = skip_status_report_return
        }
        else = {
            country_event = { id = wwu_status_report.1 }
        }
    }
}

